<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>BlackJack Pro | Elite AI Simulator</title>
    <!-- Modern Luxury Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='header-styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>

<body>
    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container"></div>

    <div id="welcome-overlay" class="welcome-overlay">
        <div class="welcome-content">
            <h1 class="glitch-text">BLACKJACK <span class="gold-accent">PRO</span></h1>
            <p class="subtitle">Simulador de IA de Alto Rendimiento</p>
            <div class="header-badges">
                <span class="badge">Q-Learning</span>
                <span class="badge">Monte Carlo</span>
                <span class="badge">Hi-Lo Count</span>
            </div>
            <button class="primary-btn gold-btn" onclick="showLobby()">Ingresar al Casino</button>
        </div>
    </div>

    <!-- Lobby Section -->
    <div id="lobby-container" class="container"
        style="display: none; justify-content: center; align-items: center; height: 100vh;">
        <div class="lobby-card glass-panel" style="width: 400px; text-align: center; padding: 40px;">
            <h2 class="glitch-text" style="font-size: 2rem; margin-bottom: 30px;">LOBBY <span
                    class="gold-accent">X</span></h2>

            <div class="control-group" style="margin-bottom: 20px;">
                <input type="text" id="username-input" class="luxury-input" placeholder="Tu Nombre de Jugador"
                    style="width: 100%; text-align: center;">
            </div>

            <button class="primary-btn gold-btn full-width" onclick="createRoom()" style="margin-bottom: 15px;">CREAR
                SALA PRIVADA</button>

            <div style="display: flex; gap: 10px;">
                <input type="text" id="room-code-input" class="luxury-input" placeholder="C√ìDIGO DE SALA"
                    style="text-transform: uppercase;">
                <button class="game-btn" onclick="joinRoom()">UNIRSE</button>
            </div>

            <div style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <button class="ghost-btn" onclick="enterSinglePlayer()">Jugar Solo (Offline Mode)</button>
            </div>
        </div>
    </div>

    <div class="container" id="main-container" style="opacity: 0; pointer-events: none;">
        <header class="luxury-header">
            <div class="header-left">
                <div class="logo">BJ <span class="gold-accent">PRO</span></div>
            </div>

            <div class="header-center">
                <div class="session-stats">
                    <div class="stat-item">
                        <span class="stat-label">Balance</span>
                        <span class="stat-value" id="header-balance">$1000</span>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <span class="stat-label">Rondas</span>
                        <span class="stat-value" id="header-rounds">0</span>
                    </div>
                </div>
            </div>

            <div class="header-right">
                <div class="theme-switcher">
                    <button class="theme-btn" onclick="toggleThemeMenu()" title="Cambiar Tema">
                        üé® <span id="current-theme-name">Midnight Casino</span>
                    </button>
                    <div class="theme-menu" id="theme-menu" style="display: none;">
                        <div class="theme-option" onclick="switchTheme('midnight-casino')">
                            <span class="theme-preview midnight"></span>
                            <span>Midnight Casino</span>
                        </div>
                        <div class="theme-option" onclick="switchTheme('royal-gold')">
                            <span class="theme-preview royal"></span>
                            <span>Royal Gold</span>
                        </div>
                        <div class="theme-option" onclick="switchTheme('neon-nights')">
                            <span class="theme-preview neon"></span>
                            <span>Neon Nights</span>
                        </div>
                        <div class="theme-option" onclick="switchTheme('classic-green')">
                            <span class="theme-preview classic"></span>
                            <span>Classic Green</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-layout">
            <div class="game-area">
                <div class="game-board" id="board-perspective">
                    <div id="card-shoe" class="card-shoe" title="Zapato de Cartas (Mazo)"></div>
                    <div id="dealer-section" class="hand-section">
                        <div class="section-title">Dealer</div>
                        <div class="cards" id="dealer-cards"></div>
                        <div class="score-pill" id="dealer-score"></div>
                    </div>

                    <div id="phase-banner" class="phase-banner hidden">ESPERANDO APUESTAS</div>
                    <div id="message-area" class="message-center">Prepare sus apuestas...</div>

                    <div id="players-container">
                        <!-- Player hands will be injected here -->
                    </div>
                </div>

                <div class="ai-live-dashboard luxury-border">
                    <div class="insight-meta">
                        <span class="status-indicator ripple"></span> ASESOR√çA IA EN TIEMPO REAL
                    </div>
                    <div class="insight-flex">
                        <div class="advice-text" id="ai-advice">Esperando datos de sesi√≥n...</div>
                        <div class="prob-visualization">
                            <div class="prob-group">
                                <label>Hit Win</label>
                                <span id="prob-hit">0%</span>
                            </div>
                            <div class="prob-group">
                                <label>Stand Win</label>
                                <span id="prob-stand">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="sidebar">
                <div class="side-card control-panel luxury-border">
                    <h3>Panel de Acciones</h3>

                    <div id="betting-area">
                        <div class="control-group">
                            <label for="diff-select">Dificultad IA:</label>
                            <select id="diff-select" class="luxury-select">
                                <option value="EASY">Principiante (Random)</option>
                                <option value="MEDIUM" selected>Est√°ndar (Basic)</option>
                                <option value="HARD">Profesional (Counter)</option>
                            </select>
                        </div>

                        <!-- Secci√≥n Auto-Round Mejorada -->
                        <div class="control-panel glass-panel" style="margin-top: 20px;">
                            <div class="panel-header">
                                <h4>ü§ñ Auto Pilot</h4>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                                <div class="control-group"
                                    style="display: flex; align-items: center; justify-content: space-between;">
                                    <label>Rondas:</label>
                                    <input type="number" id="auto-rounds-input" value="0" min="0" max="100"
                                        class="luxury-input" style="width: 80px;">
                                </div>
                                <div class="control-group"
                                    style="display: flex; align-items: center; justify-content: space-between;">
                                    <label title="Detener si saldo baja a...">üõë Stop Loss:</label>
                                    <input type="number" id="stop-loss-input" placeholder="Min $" class="luxury-input"
                                        style="width: 100px;">
                                </div>
                                <div class="control-group"
                                    style="display: flex; align-items: center; justify-content: space-between;">
                                    <label title="Detener si saldo sube a...">üí∞ Take Profit:</label>
                                    <input type="number" id="take-profit-input" placeholder="Max $" class="luxury-input"
                                        style="width: 100px;">
                                </div>
                            </div>
                        </div>

                        <div id="chip-selection" class="chip-rack">
                            <div class="chip gold" onclick="addBet(10)">10</div>
                            <div class="chip gold" onclick="addBet(50)">50</div>
                            <div class="chip gold" onclick="addBet(100)">100</div>
                        </div>

                        <div class="bet-summary">
                            Apuesta: <span id="current-bet-display" class="gold-text">$10</span>
                        </div>

                        <button class="primary-btn gold-btn full-width" id="btn-start" onclick="placeBet()">Repartir
                            Cartas</button>
                    </div>

                    <div id="game-actions" style="display: none;" class="action-buttons">
                        <div class="action-row">
                            <button class="game-btn" id="btn-hit" onclick="hit()">Pedir</button>
                            <button class="game-btn" id="btn-stand" onclick="stand()">Plantar</button>
                        </div>
                        <div class="action-row">
                            <button class="game-btn" id="btn-double" onclick="doubleDown()">Doblar</button>
                            <button class="game-btn" id="btn-split" onclick="split()"
                                style="display: none;">Dividir</button>
                            <button class="game-btn" id="btn-insurance" onclick="insurance()"
                                style="display: none;">Seguro</button>
                        </div>
                        <button class="game-btn outline" id="btn-withdraw" onclick="withdraw()">Retirarse</button>
                        <button class="primary-btn gold-btn full-width" id="btn-new-round" onclick="resetToBetting()"
                            style="display: none; margin-top: 15px;">Jugar Nueva Ronda</button>
                    </div>
                </div>

                <div class="side-card stats-panel luxury-border">
                    <h3>M√©tricas Acad√©micas</h3>
                    <div class="stat-grid">
                        <div class="mini-stat">
                            <small>RONDAS</small>
                            <span id="stat-rounds">0</span>
                        </div>
                        <div class="mini-stat">
                            <small>HI-LO</small>
                            <span id="count-value">0</span>
                        </div>
                        <div class="mini-stat highlight">
                            <small>EFECTIVIDAD IA</small>
                            <span id="stat-accuracy">0%</span>
                        </div>
                        <div class="mini-stat user-highlight">
                            <small>TU PRECISI√ìN</small>
                            <span id="stat-player-accuracy">0%</span>
                        </div>
                    </div>
                </div>

                <div class="side-card qvalue-panel luxury-border">
                    <h3>üß† AI Brain (Q-Values)</h3>
                    <div class="qvalue-display">
                        <div class="qvalue-bar">
                            <label>Q(Stand)</label>
                            <div class="qvalue-gauge">
                                <div class="qvalue-fill" id="q-stand-fill" style="width: 50%;"></div>
                            </div>
                            <span id="q-stand-value">0.000</span>
                        </div>
                        <div class="qvalue-bar">
                            <label>Q(Hit)</label>
                            <div class="qvalue-gauge">
                                <div class="qvalue-fill" id="q-hit-fill" style="width: 50%;"></div>
                            </div>
                            <span id="q-hit-value">0.000</span>
                        </div>
                        <div class="qvalue-recommendation">
                            <small>RL Optimal:</small>
                            <span id="q-optimal">-</span>
                        </div>
                    </div>
                </div>

                <div class="side-card chart-panel luxury-border">
                    <h3>An√°lisis de Saldo</h3>
                    <div class="chart-box">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
            </aside>
        </div>

        <section class="footer-analysis">
            <div class="decision-tracker luxury-border">
                <h3><i class="icon-trace"></i> Trazabilidad de Algoritmos (Q-Table & Decisions)</h3>
                <div class="log-viewport">
                    <ul id="log-list" class="elite-log"></ul>
                </div>
            </div>
            <div class="footer-actions">
                <button class="ghost-btn" onclick="toggleManual()">üìñ Manual T√©cnico & Gu√≠a IC-3002</button>
                <button class="ghost-btn" onclick="toggleLeaderboard()">üèÜ Hall of Fame</button>
            </div>
        </section>

        <!-- Rule Manual Modal -->
        <div id="rule-modal" class="modal" style="display: none;">
            <div class="modal-content professional-theme">
                <span class="close-btn" onclick="toggleManual()">&times;</span>
                <div class="doc-header">
                    <h2>IC-3002: Proyecto Blackjack AI</h2>
                    <p>Referencia Estrat√©gica y Arquitectura del Agente</p>
                </div>
                <div class="doc-body">
                    <div class="doc-section">
                        <h4>Sistemas de IA</h4>
                        <ul>
                            <li><strong>Monte Carlo:</strong> C√°lculo de esperanza matem√°tica mediante simulaciones
                                estoc√°sticas.</li>
                            <li><strong>Q-Learning:</strong> Optimizaci√≥n de la pol√≠tica de acciones mediante
                                aprendizaje reforzado (diccionario persistente).</li>
                            <li><strong>Conteo Hi-Lo:</strong> Ajuste din√°mico de la ventaja de la casa basado en la
                                composici√≥n residual del mazo.</li>
                        </ul>
                    </div>
                    <div class="doc-section">
                        <h4>M√©tricas de Evaluaci√≥n</h4>
                        <p>El sistema mide la "Precisi√≥n Estrat√©gica" comparando cada decisi√≥n del usuario y la IA
                            contra la jugada √≥ptima calculada por el simulador MC.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Modal -->
        <div id="leaderboard-modal" class="modal" style="display: none;">
            <div class="modal-content professional-theme">
                <span class="close-btn" onclick="toggleLeaderboard()">&times;</span>
                <div class="doc-header">
                    <h2>üèÜ Hall of Fame</h2>
                    <p>Top 10 Mejores Sesiones</p>
                </div>
                <div class="doc-body">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Jugador</th>
                                <th>Saldo M√°ximo</th>
                                <th>Rondas</th>
                                <th>Win Rate</th>
                                <th>Precisi√≥n</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr>
                                <td colspan="7">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="bankruptcy-modal" class="modal-overlay hidden"
            style="display: none; justify-content: center; align-items: center;">
            <div class="modal-content glass-panel"
                style="max-width: 400px; text-align: center; border: 2px solid var(--accent-red);">
                <h2 class="modal-title" style="color: var(--accent-red);">üìâ ¬°BANCARROTA!</h2>
                <p>Te has quedado sin fichas. La casa invita esta vez.</p>
                <div style="font-size: 3rem; margin: 20px 0;">üí∏</div>
                <button class="modal-close-btn" onclick="refillBalance()"
                    style="background: var(--gold-primary); color: #000; width: 100%;">Aceptar Regalo ($1000)</button>
            </div>
        </div>

    </div>
    <!-- Game Logic Modules -->
    <script type="module" src="{{ url_for('static', filename='js/game.js') }}"></script>
    <script src="{{ url_for('static', filename='ux-enhancements.js') }}"></script>
    <script src="{{ url_for('static', filename='theme-switcher.js') }}"></script>
    <script>
        // Initialize UX enhancements when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initUXEnhancements();
        });
    </script>
</body>

</html>